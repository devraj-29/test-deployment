name: Django CI/CD Pipeline

on:
  push:
    branches:
      - main # Trigger the pipeline when changes are pushed to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Python environment
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Run tests (optional step)
      - name: Run tests
        run: |
          python manage.py test

      # Set up SSH for server access
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # Deploy to server using SSH
      - name: Deploy to Server
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            cd /path/to/your/django/project
            git pull origin main  # Pull the latest code from the repo
            source venv/bin/activate  # Activate the virtual environment (if any)
            pip install -r requirements.txt  # Install the dependencies
            python manage.py migrate  # Apply migrations
            python manage.py collectstatic --noinput  # Collect static files
            systemctl restart gunicorn  # Restart Gunicorn (adjust this depending on your setup)
            systemctl restart nginx  # Restart Nginx (if applicable)
          EOF
